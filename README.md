# Telegram ChatrixBot
(Not in production)
## Команды
### About 
Бот предназначен для ведения изменений значений некоторого показателя с течением времени (например, массы тела, роста). Периодически добавляйте текущее значение, и в итоге можете построить график изменений.

По сути, цель - получить визуальное представление некого прогресса.

Примеры использования:
- Вы хотите следить за изменением веса, каждый день взвешиваетесь и боту отправляете 1 значение.
- Вы хотите построить график роста ребенка
	- Периодически меряете рост, отправляете значение боту
	- Или отправляете боту несколько сообщений со значением роста и дату со временем, и тогда сразу можно построить график
- Вы занимаетесь спортом, и каждый день фиксируете сколько удалось сделать подходов, затем строите график и видите свой прогресс.

### Help
Допустимый формат ввода значений:
```code
Число Дата Время
```

- **Число** - целое или с точкой, обязательное,
- **Дата** - в формате день.месяц или день.месяц.год, необязательное,
- **Время** - в формате часы:минуты, необязательное,

Если не указаны дата или время, будет использовано текущее время.

### Start
Начало работы. Бот запросит название и единицу измерения показателя по-умолчанию.

### Menu
Команда вызывает иерархическое меню:
- Показатели
	- Показать текущий показатель
	- Добавить показатель
	- Удалить показатель
	- Изменить текущий показатель
- Удалить значение
- Построить график
- Выгрузить / загрузить
	- Выгрузить в json-файл
	- Загрузить из json-файла

## Пример использования
В бот можно загрузить тестовые значения из файла [[files/metrics.json]].
Вызвать команду меню **/menu**
![Command-Menu](../blob/main/files/Command-Menu.JPG)

Меню Показатели
![[Menu-Metric.JPG]]

Можно посмотреть список значений
![[Delete-Value-2.JPG]]

И посмотрить график по ним
![[plot141883194.png]]

## Особенности бота
- Кнопочное меню динамически меняет состав кнопок в рамках одного сообщения (как у BotFather), то есть нажатие на кнопку не создает новое сообщение с новым набором кнопок.
- Если у пользователя в настройках указан язык Русский, то бот будет отвечать по-русски, иначе -  on English.
(Вероятно язык определяется по системным настройкам - [NEW Multilingual Bots](https://core.telegram.org/bots/api-changelog#may-18-2017)).

## Настройки
В проекте в файл appsettings.json, а лучше в appsettings.Production.json, нужно добавить значения:
- **Token**: значение API Token, полученное от **BotFather** после регистрации бота;
- **WebhookUrl**: url, на который Telegram API будет присылать сообщения от пользователей.

Пример:
```js
"BotConfig": {
	"Token": "<API_Token>",
	"WebhookUrl": "<Web_hook_Url>"
}
```

### Локальное тестирование 
Параметры конфигурации можно добавить в appsettings.Development.json.

Для получения запросов на локальную машину, можно использовать  [ngrok](https://ngrok.com/download). Он предоставляет временный сабдомен, на который Telegram API может отправлять сообщения пользователей, и ngrok будет перенаправлять их в ваш бот.
Запускаете ваше приложение по адресу.
```js
"applicationUrl": "http://localhost:8443",
```

Запускаете ngrok на том же порту 8443.
```code
ngrok http 8443 
```

Ngrok предоставит вам https URL вида 
```code
https://yoursubdomain.ngrok.io 
```
Именно этот URL нужно указать в параметре **WebhookUrl**  в **BotConfig** выше в виде
```code
https://yoursubdomain.ngrok.io/api/update
```

## БД
Для хранения данных используется файл Chartix.db от СУБД SQLite.

## На чем написан и что используется
- [.NET 5](https://github.com/dotnet/core)
- [TelegramBot (15.7.1)](https://github.com/TelegramBots/Telegram.Bot)
- SQLite ([Microsoft.EntityFrameworkCore.Sqlite 5.0.2](https://github.com/dotnet/efcore))
- [ScottPlot (4.0.48)](https://github.com/ScottPlot/ScottPlot)
- [StyleCop.Analyzers (1.1.118)](https://github.com/DotNetAnalyzers/StyleCopAnalyzers)
